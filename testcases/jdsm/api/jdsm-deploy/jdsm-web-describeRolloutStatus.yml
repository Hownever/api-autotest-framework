name: 根据云翼服务树中应用名称配置服务网格的基本配置项-$product-$env-$host
variables:
    host: ${ENV(ENV_JDMESH_WEB_BASE_URL)}
    expected_status_code: 200
    product: productpage
    fullname: Corp_product.Dep_middleware.Pdl_microservices.Sys_internal-microservices.App_productpage
    env: pre

    requestid: ${get_timestamp(13)}${gen_random_string(19)}
    headers:
        ajax-id: $requestid
        x-jdcloud-request-id: $requestid
    global_headers: {"ajax-id": "$requestid", "x-jdcloud-request-id": "$requestid"}
    cookies:
         _ga: ${ENV(ENV_COOKIES)}

request:
    # http://mesh-online.ark.jdcloud.com/openApi/jdmesh/describeRolloutStatus HTTP/1.1
    url: $host/openApi/jdmesh/describeRolloutStatus
    method: POST
    headers: $headers
    cookies: $cookies

    # {"params":{"appName":"productpage","fullName":"Corp_product.Dep_middleware.Pdl_microservices.Sys_internal-microservices.App_productpage","env":"pre"}}
    json:
        params:
            appName: $product
            env: $env
            fullName: $fullname

setup_hooks:
    - ${hook_update_request_insert_global_headers($request, $global_headers)}

validate:
    - eq: ["status_code", $expected_status_code]

# response
# {
#    "requestId":"bmsq20dr52wgsg4c2o0vjerrj7ffdgko",
#    "error":null,
#    "result":{
#        "deployment":[
#            {"arkGroupName":"east2-pre","arkGroupNameCn":"east2-pre","env":"pre","groupImageVersion":"istio1.2.2-develop-35b7c873-0906174008","trafficStatus":true},
#            {"arkGroupName":"east2-pre-az2","arkGroupNameCn":"east2-pre-az2","env":"pre","groupImageVersion":"istio1.2.2-develop-35b7c873-0815104718","trafficStatus":false}
#            ]}}
