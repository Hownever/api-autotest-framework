- config:
    name: 创建子账号-创建策略：允许createApiGroup-绑定策略-请求接口-成功-解绑策略后-请求失败
    base_url: ${ENV(ENV_BASE_URL)}
    variables:
        product: ${ENV(ENV_PRODUCT)}
        apiVersion: ${ENV(ENV_API_VERSION)}
        openapi_yaml: ${ENV(ENV_OPENAPI_SWAGGER_FILE_PATH)}
        regionId: ${ENV(ENV_DEFAULT_REGIONID)}
        api_ver: ${ENV(ENV_API_VERSION)}
        AK: ${ENV(ENV_AK)}
        SK: ${ENV(ENV_SK)}
        main_pin: ${ENV(ENV_PIN)}
        GroupName: ${get_name(GroupName)}
    verify: False

- test:
    name: 创建子账号-获取子账号的pin-获取成功
    testcase: testcases/monitor/createSubUser_getPin.yml
    variables:
        subUserName: SubUser_have_pol
    output:
        - subUser_name
        - accessKey
        - secretAccessKey
        - subUser_pin

- test:
    name: 创建策略：Policy_createApiGroup，创建成功
    api: api/monitor/createPolicy.yml
    variables:
        pin: $main_pin
        name: Policy_createApiGroup
        description: Policy_createApiGroup
        content: '{"Version":3,"Statement":[{"Effect":"Allow","Action":["apigateway:createApiGroup"],"Resource":["*"],"Condition":{}}]}'
    extract:
        - policyName: content.result.policy.name
    output:
        - policyName

- test:
    name: 子用户绑定策略：Policy_createApiGroup，绑定成功
    api: api/monitor/attachSubUserPolicy.yml
    variables:
        subUser: $subUser_name
        pin: $main_pin
        policyName: $policyName

- test:
    name: 子用户请求createApiGroup接口，网关未拦截，请求成功
    api: api/monitor/createApiGroup.yml
    variables:
        pin: $subUser_pin @ $main_pin
        groupName: $GroupName
        description: aaa
        prefix: aaa
        keyCheck: check_exist
        authType: jd_cloud
    extract:
        - apiGroupId: content.result.apiGroupId
    validate:
        - eq: ["status_code", 200]

- test:
    name: 主账号请求detachSubUserPolicy接口，解绑策略成功，延迟40s
    api: api/monitor/detachSubUserPolicy.yml
    variables:
        subUser: $subUser_name
        pin: $main_pin
        policyName: $policyName
    validate:
        - eq: ["status_code", 200]

- test:
    name: 子用户请求createApiGroup接口，网关会报错You are not authorized
    api: api/monitor/createApiGroup.yml
    variables:
        pin: $subUser_pin @ $main_pin
        groupName: $GroupName
        description: aaa
        prefix: aaa
        keyCheck: check_exist
        authType: jd_cloud
    validate:
        - eq: ["status_code", 403]
        - contains: [content.error.message, You are not authorized to perform (apigateway:createApiGroup) on resource (*)]
        - eq: [content.error.status, HTTP_FORBIDDEN]

- test:
    name: 子用户绑定策略：Policy_createApiGroup成功，延迟40s
    api: api/monitor/attachSubUserPolicy.yml
    variables:
        subUser: $subUser_name
        pin: $main_pin
        policyName: $policyName

- test:
    name: 子用户请求createApiGroup接口，网关未拦截，请求成功
    api: api/monitor/createApiGroup.yml
    variables:
        pin: $subUser_pin @ $main_pin
        groupName: $GroupName
        description: aaa
        prefix: aaa
        keyCheck: check_exist
        authType: jd_cloud
    extract:
        - status: content.error.status
    validate:
        - eq: ["status_code", 409]
        - eq: [$status, APIGATEWAY_APIGROUPNAME_ISREPEAT]

- test:
    name: 删除子用户
    api: api/monitor/deleteSubUser.yml
    variables:
        pin: $main_pin
        subUser: $subUser_name

- test:
    name: 删除策略
    api: api/monitor/deletePolicy.yml
    variables:
        pin: $main_pin
        policyName: $policyName